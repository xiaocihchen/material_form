<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>備品領用登記表</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>備品領用登記表</h1>
  <h4>📷 掃描 QRCode 可自動帶入儲位與料號</h4>

  <div id="reader" style="width:300px;"></div>
  <br>

  <form id="materialForm">
    領取人：<input name="person" required><br><br>
    單位　：<input name="unit" required><br><br>
    儲位　：<input name="location" id="location"><br><br>
    料號　：<input name="itemNo" id="itemNo"><br><br>
    數量　：<input name="qty" type="number" required><br><br>
    <button type="submit">送出</button>
  </form>

  <div id="resultMsg" style="margin-top:20px; color:green;"></div>

  <script>
    const apiURL = "https://api.sheety.co/9f325b6b8a2b30e493977572df4f8d27/備品領用登記表/2025";

    // QRCode 掃描成功處理
    function onScanSuccess(decodedText) {
      console.log("掃描成功:", decodedText);
      const parts = decodedText.split("|");
      if (parts.length >= 4) {
        document.getElementById("location").value = parts[2];
        document.getElementById("itemNo").value = parts[3];
      } else {
        alert("⚠️ QRCode 格式錯誤，應為 'xx|xx|儲位|料號'");
      }
    }

    function onScanFailure(error) {
      // 可忽略錯誤
    }

    // 初始化 QRCode 掃描器
    window.onload = () => {
      const qrScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250
      });
      qrScanner.render(onScanSuccess, onScanFailure);
    };

    // 表單送出處理
    document.getElementById("materialForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      const data = {
        2025: {
          person: formData.get("person"),
          unit: formData.get("unit"),
          location: formData.get("location"),
          itemNo: formData.get("itemNo"),
          qty: formData.get("qty"),
          timestamp: new Date().toISOString()
        }
      };

      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(response => {
        if (!response.ok) throw new Error("HTTP 錯誤 " + response.status);
        return response.json();
      }).then(json => {
        document.getElementById("resultMsg").innerText = "✅ 表單送出成功！";
        document.getElementById("materialForm").reset();
        document.getElementById("location").value = "";
        document.getElementById("itemNo").value = "";
      }).catch(err => {
        document.getElementById("resultMsg").innerText = "❌ 送出錯誤：" + err;
      });
    });
  </script>
</body>
</html>
